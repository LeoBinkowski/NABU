	.Z80
;------------------------------------
;	TIMER SUBROUTINES           |
;------------------------------------
;	08MAY84	JF	SOUND 	STIME=TIME RUNNING OUT
;		
;	18APR84			    |
;------------------------------------
	.RADIX	10
	.XLIST
CCP	EQU	0	;0=PRODUCTION [LEO KILLS WITH RADIOACTIVE
			;1=TEST SET NXT_GUY WHEN OUT OF TIME

	INCLUDE COMMON.MRO
	INCLUDE	STRUCT.MRO
	INCLUDE ARITH.MRO

FILL	MACRO	FRADD,BYTES,WHAT
	LOCAL	ZEROM,LOOP
ZEROM:	LD B,BYTES		;LENGTH OF BUFFER TO CLEAR
	LD HL,FRADD		;BASE ADDRESS
LOOP:	LD (HL),WHAT		;LOAD INTO (HL) GIVEN VALUE WHAT
	INC HL			;INCREMENT BUFFER POINTER
	DJNZ LOOP		;DEC B, JUMP TO LOOP IF NOT ZERO
	ENDM

COPBUF	MACRO	FRADD,TOADD,TOTBTS
	LD DE,TOADD
	LD HL,FRADD
	LD BC,TOTBTS
	LDIR
	ENDM

	.LIST

	EXTRN	FASBUF,FBUFP,VIDADD,NUMIES
	EXTRN	VRAML8,NXT_GUY,RADIOACTIVE
	EXTRN	STIME

	TONNAGE::	DB	0
;***********************************************************
;	SSTART::	DB	0	;FAKE SOUND FLAGS
;	SPRIZE::	DB	0	
;	SKILL::		DB	0
;	STIME::		DB	0	;SEE EXTRN ABOVE
;	SBONUS::	DB	0
;	SOVER::		DB	0
;	SDLEVEL::	DB	0
;	SFREE::		DB	0
;*****************************************************************

;********** TIME DECLARES ***************
	BASE:		DW	0	;HANDY-DANDY
	ADD:		DW	0	;HANDY-DANDY
	I:		DB	0	;HANDY-DANDY
	TIMER::		DB	0  ;2 DIGIT BCD TIME COUNT-DOWN (00 DUMMIES)
	TIMTCB::	DS	6	;TCB FOR TIMTSK
	TIMFLG::	DB	0	;FLAG TO UP UP TIME IN DISTIM
	TIMBUF::	DB	0,0,0,0	;4 DIGITS MADE UP FROM NUMIES
	TIMOUT::	DB	0	;FLAGS TIME RUNNING OUT
	TICKY::		DB	0	;TOGGLES IN TIMTSK EVERY ALTERNATE TIME

TIMTSK::
;	KEEPS TIMER FOR GAME

	LD A,(TICKY)		;TOGGLE SUCKER
	XOR 1			;
	LD (TICKY),A		;PUT BACK
	IF8. (TICKY),.EQ.,1	;CHANGE TIME ON TICKY ONLY
	  XOR A			;CLEAR FLAGS
	  LD	A,(TIMER)	;GET THE HIGH ORDER BYTE
	  DEC	A		;DECREMENT ONCE PER CALL
	  DAA			;ADJUST IT TO BCD
	  LD	(TIMER),A	;PUT IT BACK
	  IF8. (TIMER),.LT.,9	;RUNNING OUT OF TIME
		ASIGN8. (TIMOUT),1
		ASIGN8. (STIME),1	;TURN ON COUNTDOWN SOUND
	  ENDIF.
	  IF8. (TIMER),.LT.,1	;OUT OF TIME
		ASIGN8. (RADIOACTIVE),1	;SET BB RADIACTIVE FOR LEO
		ASIGN8. (STIME),0	;TURN OFF COUNTDOWN SOUND
		IF CCP	;FOR TEST ONLY
		  ASIGN8. (NXT_GUY),1	;BOB IS DEAD
		ENDIF
	  ENDIF.
	  ASIGN8. (TIMFLG),1	;FLAG TO DISPLAY TIME
	ENDIF.	;IF (TICKY)=1

	RET	;END OF TIMTSK

DISTIM::
	IF8. (TIMFLG),.EQ.,0	;NO TIME TO DISPLAY (HAS NOT CHANGED)
		JP XDISTM	;EXIT
	ENDIF.
;CREATE TIMBUF
	LD A,(TIMER)		;BCD TIME COUNTER
	SRL A			;SHIFT RIGHT 4
	SRL A
	SRL A
	SRL A
	JP NZ,GODIS		;IF NOT 0, GO ON
	LD A,12			;IF ZERO, MAKE IT BLANK [12]
GODIS::	LD (TIMBUF),A		;FIRST ELEMENT OF TIMER
	LD A,(TIMER)
	AND 00FH		;GET RID OF LEFT ELEMENT
	LD (TIMBUF+1),A		;THE LAST TWO ARE DUMMY ZEROS
;TRANSLATE TIMBUF TO FASBUF & PUT FASBUF IN VRAM
	ASIGN16. (VIDADD),112	;MIDDLE OF 1ST ROW
	ASIGN16. (BASE),TIMBUF	;
	ASIGN16. (FBUFP),FASBUF
	ASIGN8. (I),0		;COUNTER
	WHILE8. (I),.LT.,4	;TIME BUFFER IS 4 LONG
		LD HL,(BASE)		;ADDRESS OF BUFFER OFFSET
		LD A,(HL)		;NUMBER
		SLA A			;TIMES 8
		SLA A			;
		SLA A			;
		LD C,A			;PUT IN BC
		LD B,0					;MAKE IT A WORD
		LD HL,NUMIES				;BASE OF NUMBERS TABLE
		ADD HL,BC			;ADDRESS OF NUMBER PATTERN
		LD (ADD),HL
		COPBUF (ADD),(FBUFP),8		;PUT 8 BYTES (NUMBER) IN FASBUF
		ADD16. (FBUFP),8		;SAVE NEXT (FBUFP)
		LD HL,(BASE)			;INCREMENT SCORE BUFFER
		INC HL				;
		LD (BASE),HL			;PUT IT IN (BASE)
		ADD8. (I),1			;INCREMENT COUNTER
	ENDW.
	PCALL VRAML8,32,FASBUF,(VIDADD)
	ASIGN8. (TIMFLG),0			;RESET FLAG
	IF8. (TIMOUT),.GT.,0		;RUNNING OUT OF TIME
		;DO GETTING RADIOACTIVE ROUTINE
	ENDIF.

XDISTM:	RET	;END OF DISTIM



	END

